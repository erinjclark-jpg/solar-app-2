<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SolarCheck Professional</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9; 
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }
        .toggle-checkbox:checked {
            right: 0;
            border-color: #68D391;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #68D391;
        }
        .toggle-checkbox {
            right: 0;
            z-index: 1;
            transition: all 0.3s;
        }
        
        /* Tab Animation */
        .tab-content {
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @media print {
            .no-print { display: none !important; }
            body { background: white; }
            /* Ensure background graphics (colors) are printed */
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
        }

        /* Toast Notification */
        .toast-notification {
            position: fixed;
            top: 1rem;
            right: 1rem;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            z-index: 60;
            animation: slideIn 0.3s ease-out;
            color: white;
            font-weight: 600;
            font-size: 0.875rem;
        }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Hide number input arrows (spin buttons) */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        input[type=number] {
            -moz-appearance: textfield; /* Firefox */
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- 1. Global Setup (Attaching to Window) ---
        window.state = {
            activeTab: "inputs", 
            activeModal: null, 
            a: "",
            iDt: "2015-02-19",
            pDt: new Date().toISOString().split('T')[0],
            o: "lease", 
            pC: 38,
            pW: 255,
            sz: 9.69,
            or: "mix",
            pi: "standard",
            sh: "some",
            ac: 103,
            b: 0,
            it: "string", 
            ut: "nem2",
            te: 20,
            tE: 10525,
            tG: 9472,
            tEs: 2.9,
            pa: 223.66,
            tR: 0.255,
            rR: 0.20,
            rC: 3.50,
            ne: 0.8,
            c: 0.9,
            aC: true,
            l: 30,
            om: 20,
            dr: 7.88,
            rp: 0,
            tx: false,
            mt: "Blended",
            e: 3.5,
            w: 50,
            r: null,
            aR: null,
            reportTitle: "",
            reportMode: "standard" 
        };

        // --- API CONFIGURATION ---
        const API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=";
        const apiKey = "AIzaSyCAFdqXSVEFCGvGHXhj33-io2xm0-9xU8s"; 

        // --- 2. Firebase Init ---
        const appId = typeof window.__app_id !== 'undefined' ? window.__app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof window.__firebase_config !== 'undefined' ? window.__firebase_config : '{}');
        const initialAuthToken = typeof window.__initial_auth_token !== 'undefined' ? window.__initial_auth_token : null;

        let db, auth;

        const initFirebase = async () => {
            if (Object.keys(firebaseConfig).length === 0) {
                console.warn("Running in offline mode (No Firebase Config).");
                return;
            }
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('error');
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                console.log("Firebase initialized.");
            } catch (error) {
                console.error("Firebase Error:", error);
            }
        };

        initFirebase();

        // --- 3. Helper Functions ---
        function cur(v) { return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(v || 0); }
        function num(v) { return new Intl.NumberFormat('en-US', { maximumFractionDigits: 1 }).format(v || 0); }
        function per(v) { return (v * 100).toFixed(1) + "%"; }

        function showToast(message, type = 'error') {
            const toast = document.createElement('div');
            toast.className = `toast-notification ${type === 'error' ? 'bg-red-500' : type === 'warning' ? 'bg-amber-500' : 'bg-green-500'}`;
            toast.innerHTML = `<i class="fas ${type === 'error' ? 'fa-circle-exclamation' : type === 'warning' ? 'fa-triangle-exclamation' : 'fa-check-circle'} mr-2"></i>${message}`;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        async function fetchWithExponentialBackoff(url, options = {}, retries = 5) {
            try {
                // Safeguard against invalid RequestInit which causes "The provided value is not of type 'RequestInit'"
                if (!options || typeof options !== 'object') {
                    throw new Error("Invalid API options provided.");
                }

                const cleanKey = apiKey ? apiKey.trim() : "";
                const fullUrl = url + cleanKey;
                
                const response = await fetch(fullUrl, options);
                
                if (!response.ok) {
                    let errorMsg = `HTTP ${response.status} ${response.statusText}`;
                    try {
                        const errorData = await response.json();
                        if (errorData && errorData.error) {
                            errorMsg = `${errorData.error.status || 'Error'}: ${errorData.error.message}`;
                        }
                    } catch (e) { }
                    throw new Error(errorMsg); 
                }
                return await response.json();
            } catch (error) {
                // Do not retry if the error is a type mismatch or invalid argument (programming error)
                if (error.name === 'TypeError' || error.message.includes('RequestInit') || error.message.includes('Invalid API')) {
                    throw error;
                }
                
                // Do not retry on 400 (Bad Request) or 401/403 (Auth) errors
                if (error.message.includes('400') || error.message.includes('401') || error.message.includes('403') || error.message.includes('INVALID_ARGUMENT')) {
                    throw error;
                }

                if (retries === 0) { throw new Error(error.message || "Failed to connect."); }
                
                const delay = Math.pow(2, 5 - retries) * 1000 + Math.random() * 1000;
                await new Promise(resolve => setTimeout(resolve, delay));
                return fetchWithExponentialBackoff(url, options, retries - 1);
            }
        }

        // --- 4. Core Logic ---
        function calculate() {
            // FIX: Added 'o' (ownership type) to extraction
            const { pC, pW, iDt, pDt, or, sh, pi, ac, b, it, ut, tE, tG, tEs, pa, tR, rR, rC, ne, c, l, om, dr, rp, tx, mt, e, w, te, o } = window.state;
            
            // System size
            const s = (pC * pW) / 1000;
            window.state.sz = s;

            // Age
            const iT = +new Date(iDt), pT = +new Date(pDt);
            const age = (iT && pT && pT > iT) ? (pT - iT) / (1000 * 60 * 60 * 24 * 365.25) : 0;

            // Yield Factor
            const YF = { south: 1550, mix: 1500, east_west: 1450, north: 1200 }[or] *
                { none: 1, some: 0.85, alot: 0.7 }[sh] *
                { standard: 1, flat: 0.89, steep: 0.96 }[pi];

            const th = s * YF; // Theoretical annual
            const aK = ac * 1000; // Actual Lifetime kWh
            const dA = 1 - ((age / 2) * 0.005); // Degradation Avg
            const eL = th * age * dA; // Expected Lifetime
            const pr = eL > 0 ? aK / eL : 0; // Performance Ratio

            // Auto-condition
            if (window.state.aC) {
                let nC = pr;
                if (!isFinite(nC)) nC = 1;
                nC = Math.min(1.0, Math.max(0, nC));
                if (Math.abs(nC - c) > 0.005) { window.state.c = parseFloat(nC.toFixed(2)); }
            }

            // Financials
            const sR = Math.min(0.40 + (b * 0.035), 0.95);
            const rU = { nem2: 0.48, nem3: 0.48, roseville: 0.16, smud: 0.19, xcel_co: 0.16, other: 0.35 }[ut] || 0.35;
            const eU = { nem2: 0.45, nem3: 0.05, roseville: 0.06, smud: 0.07, xcel_co: 0.16, other: 0.05 }[ut] || 0.05;

            const cP = th * (1 - (age * 0.005));
            const pS = (cP * sR * rU) + (cP * (1 - sR) * eU);
            const aS = pS * pr;
            const loss = pS - aS;
            const eN = cP * pr;
            const eD = eN / 365;

            // TPO Logic
            let tEt = 0, tGt = 0;
            const fY = Math.floor(age);
            for (let i = 0; i < fY; i++) {
                const d = 1 - (i * 0.005);
                tEt += tE * d;
                tGt += tG * d;
            }
            const par = age - fY;
            const pDm = 1 - (fY * 0.005);
            tEt += tE * pDm * par;
            tGt += tG * pDm * par;

            const gD = (aK / 1000) - (tGt / 1000);
            const nYg = tG * (1 - (Math.floor(age) * 0.005));
            const nYV = (eN / 1000) - (nYg / 1000);

            // Remaining Contract
            let tCt = 0, aP = pa * 12;
            for (let i = 0; i < te; i++) {
                tCt += aP;
                aP *= (1 + (tEs / 100));
            }

            // Full Term Totals (kWh)
            let fTe = 0, fTg = 0;
            const term = parseFloat(te) || 20;
            const year1Est = parseFloat(tE) || 0;
            const year1Guar = parseFloat(tG) || 0;

            for(let i=0; i<term; i++){
                 const d = 1 - (i * 0.005);
                 fTe += year1Est * d;
                 fTg += year1Guar * d;
            }

            // --- IMPROVED UTILITY SAVINGS CALCULATION (Owned vs TPO) ---
            const aE = e / 100; // Utility Escalator
            const bR = (sR * rU) + ((1 - sR) * eU); // Current Blended Rate $/kWh

            // 1. PAST SAVINGS (Estimate)
            // We use the "Midpoint Rate" heuristic to estimate past value
            // Rate at install = bR / (1+aE)^age. Average rate approx at age/2.
            const pastAvgRate = bR / Math.pow(1 + aE, age / 2);
            const pSav = aK * pastAvgRate; // Lifetime kWh * Avg Rate

            // 2. FUTURE SAVINGS (Projection)
            let fSa = 0;
            // FIX: Ensure 'o' and 'te' are defined for calcTerm logic
            const calcTerm = (o === 'owned') ? 25 : (te || 20); // Default to 20 if 'te' is missing for some reason
            const rM = Math.max(0, calcTerm - age); // Remaining years
            const yearsToCalc = Math.ceil(rM);

            for (let i = 0; i < yearsToCalc; i++) {
                // Determine degradation factor for this specific future year (Linear 0.5%)
                // (age + i) is the age of the system in that future year
                const degFactor = Math.max(0, 1 - ((age + i) * 0.005));
                
                // Projected Production: Theoretical New * Degradation * Current Performance Ratio
                const yearlyProd = th * degFactor * pr;

                // Projected Rate: Current Rate * Escalator^i
                const yearlyRate = bR * Math.pow(1 + aE, i);

                // Handle fractional last year
                let fraction = 1;
                if (i === yearsToCalc - 1) {
                    fraction = rM - Math.floor(rM);
                    if (fraction === 0 && rM > 0) fraction = 1; // Handle exact integer case
                }

                fSa += yearlyProd * yearlyRate * fraction;
            }

            const tS = pSav + fSa;

            // Year 1 vs Current vs End
            const iC = Math.floor(age);
            const iL = te - 1;
            const pYC = pa * Math.pow(1 + (tEs / 100), iC);
            const rYC = (tE * (1 - (iC * 0.005))) > 0 ? (pYC * 12) / (tE * (1 - (iC * 0.005))) : 0;
            const pYL = pa * Math.pow(1 + (tEs / 100), iL);
            const rYL = (tE * (1 - (iL * 0.005))) > 0 ? (pYL * 12) / (tE * (1 - (iL * 0.005))) : 0;

            window.state.r = {
                age, sz: s, act: ac, estL: tEt / 1000, guaL: tGt / 1000, pr, gDiff: gD,
                potSav: pS, actSav: aS, loss, curProd: cP, estN12: eN, estDay: eD,
                nYG: nYg, nYV, tCost: tCt, futSav: fSa, totSav: tS,
                pY1: pa, rY1: tE > 0 ? (pa * 12) / tE : 0,
                pYC, rYC, pYL, rYL, fTe, fTg,
                estLifeKwh: tEt / 1000, estLifeMwh: tEt / 1000, guarLifeMwh: tGt / 1000,
                physLifeMwh: eL / 1000 // Added Physical Lifetime Expectancy in MWh for Owned Card
            };

            // Valuation
            const sC = s * 1000 * rC;
            const bR2 = b * 1000;
            const rL = Math.max(0, l - age);
            const dep = l > 0 ? (rL / l) * c * ne : 0; // Keeping ne for backward compatibility if needed, but per request it should be removed.
            // Correction: Remove * ne from calculation to ensure Cost Approach is pure physical.
            const depCost = l > 0 ? (rL / l) * c : 0; // Pure physical depreciation
            
            const cV = sC * depCost + (bR2 * Math.max(0, 1 - (age * 0.1)));

            let dcf = 0, cpr = cP;
            const oCt = s * om;
            let yD = [];
            for (let y = 1; y <= rL; y++) {
                const net = (cpr * bR) + (b > 0 ? cpr * bR * 0.2 : 0) - (oCt * Math.pow(1.02, y - 1));
                dcf += net / Math.pow(1 + (dr / 100), y);
                yD.push({ y, c: dcf });
                cpr *= 0.993;
            }

            const iV = Math.max(0, dcf - (rp === "" ? 0 : parseFloat(rp)));
            const fC = cV + (b > 0 ? 1500 : 0) - (rp === "" ? 0 : parseFloat(rp));
            const fI = iV + (b > 0 ? 1500 : 0);

            let fV;
            if (mt === "Blended") {
                const wI = w / 100;
                const wC = 1 - wI;
                fV = (fI * wI) + (fC * wC);
            } else if (mt === "Income") { fV = fI; } else { fV = fC; }

            let tr = 0;
            if (tx && age < 5) tr = (sC + bR2) * 0.30 * [1, .8, .6, .4, .2][Math.floor(age)];

            window.state.aR = { cost: fC, inc: fI, val: fV, tr, buy: fV + tr, yD };
        };

        // --- NEW HELPERS FOR MODAL STATE ---
        function openModal(id) {
            window.state.activeModal = id;
            render();
        }

        function closeModal() {
            window.state.activeModal = null;
            render();
        }

        // --- AI HELPERS & PROMPT BUILDER (RESTORED) ---
        function buildPrompt(reportType, inputs) {
            const { systemSize, annualSavings, age, fairMarketValue, tpoMonthlyPayment, tpoEscalator, tpoGuaranteeMWh, tpoActualMWh, address, installDate, performanceRatio, totalLifetimeSavings, battery, inverterType, condition, utilityRate, repairs } = inputs;
            const formatRule = "**CRITICAL FORMATTING RULE:** Do NOT use LaTeX or MathJax formatting. Use standard text for all currency ($) and units (kWh, MWh). USE MARKDOWN TABLES for comparisons.";
            let systemPrompt;
            let userQuery;
            const batStr = battery > 0 ? `includes ${battery}kWh Battery Storage` : "is Solar PV only";
            const invStr = inverterType === 'micro' ? "Microinverters (High Reliability)" : "String Inverter";
            const condStr = condition > 0.9 ? "Excellent" : condition > 0.8 ? "Good" : "Fair/Poor";

            switch (reportType) {
                case 'owned':
                    systemPrompt = `You are an expert solar consultant. Generate a reassuring report for a homebuyer. ${formatRule}
                    The system is ${age.toFixed(1)} years old and ${batStr}.
                    Hardware: ${invStr}. 
                    Key Points:
                    1) Financial Value (Est Annual $${annualSavings.toFixed(0)}),
                    2) System Health (PR ${per(performanceRatio)} - Target >90%), 
                    3) Lifecycle (Age ${age.toFixed(1)} yr). Emphasize durability and repairability.`;
                    userQuery = `Generate Solar Asset Transfer Report. Address: ${address}. Age: ${age.toFixed(1)}. Size: ${systemSize.toFixed(2)}kW. Savings: $${annualSavings.toFixed(0)}/yr. PR: ${performanceRatio.toFixed(2)}. Battery: ${battery}kWh.`;
                    break;
                case 'lease':
                    systemPrompt = `You are a Solar Lease Specialist. Explain the benefits of "Solar-as-a-Service". ${formatRule}
                    Cover: 
                    1) Fixed Payments ($${tpoMonthlyPayment.toFixed(2)} with ${tpoEscalator}% annual escalator), 
                    2) Cost vs Utility (${utilityRate} rates are rising), 
                    3) Production Guarantee (${tpoActualMWh.toFixed(1)} actual vs ${tpoGuaranteeMWh.toFixed(1)} MWh guaranteed), 
                    4) Transfer Process.`;
                    userQuery = `Generate Solar Lease Assumption Report. Address: ${address}. Size: ${systemSize.toFixed(2)}kW. Pay: $${tpoMonthlyPayment.toFixed(2)}. Esc: ${tpoEscalator}%. Guar: ${tpoGuaranteeMWh.toFixed(1)}MWh. Act: ${tpoActualMWh.toFixed(1)}MWh.`;
                    break;
                case 'ppa':
                    systemPrompt = `You are a PPA Analyst. Explain "Pay-for-Performance". ${formatRule}
                    Cover: 1) PPA Model (Pay for produced energy only), 2) Performance Obligation, 3) Rate Analysis.`;
                    userQuery = `Generate PPA Transfer Report. Address: ${address}. Size: ${systemSize.toFixed(2)}kW. Act: ${tpoActualMWh.toFixed(1)}MWh.`;
                    break;
                case 'val':
                    systemPrompt = `You are an Independent Valuation Analyst using Income Capitalization Approach. ${formatRule}
                    CRITICAL: This valuation is based on a PHYSICAL SITE INSPECTION, not a generic desktop model.
                    Emphasize that leasing companies (TPOs) often use theoretical 35-year lifespans to inflate value, whereas this report uses realistic inputs verified on-site.
                    System Condition Factor: ${condition.toFixed(2)} (${condStr}).
                    Repairs Needed: $${repairs}.
                    Cover: 1) Method (Income Cap), 2) Inputs (Risk Rate ${inputs.dr}%, Repairs $${inputs.rp}, O&M), 3) Tax Recapture, 4) FMV Conclusion ($${fairMarketValue.toFixed(0)}), 5) The credibility of physical inspection vs desktop averages.`;
                    userQuery = `Generate FMV Appraisal Report. Size: ${systemSize.toFixed(2)}kW. Age: ${age.toFixed(1)}. Repairs: $${inputs.rp}. PV CashFlow: $${inputs.aR.inc.toFixed(0)}. Cost Appr: $${inputs.aR.cost.toFixed(0)}. FMV: $${fairMarketValue.toFixed(0)}.`;
                    break;
                default:
                    throw new Error("Invalid report type.");
            }
            return { systemPrompt, userQuery };
        }

        function parseMarkdown(markdown) {
            if (!markdown) return '';
            let lines = markdown.split('\n');
            let htmlLines = [];
            let inTable = false;
            let tableBuffer = [];
            for (let i = 0; i < lines.length; i++) {
                let line = lines[i].trim();
                if (line.startsWith('|') && line.endsWith('|')) {
                    if (!inTable) { inTable = true; }
                    tableBuffer.push(line);
                } else {
                    if (inTable) {
                        htmlLines.push(convertTable(tableBuffer));
                        tableBuffer = [];
                        inTable = false;
                    }
                    htmlLines.push(processLine(line));
                }
            }
            if (inTable) { htmlLines.push(convertTable(tableBuffer)); }
            return htmlLines.join('');
        }

        function convertTable(lines) {
            if (lines.length < 2) return lines.join('<br>');
            const headerRow = lines[0];
            const headers = headerRow.split('|').filter(c => c.trim() !== '').map(c => c.trim());
            const bodyRows = lines.slice(2);
            let tableHtml = `<div class="overflow-x-auto my-6 rounded-lg border border-slate-200 shadow-sm"><table class="min-w-full divide-y divide-slate-200 text-sm">`;
            tableHtml += `<thead class="bg-slate-50"><tr>`;
            headers.forEach(h => { tableHtml += `<th class="px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase tracking-wider">${h}</th>`; });
            tableHtml += `</tr></thead><tbody class="bg-white divide-y divide-slate-200">`;
            bodyRows.forEach(row => {
                const cells = row.split('|').filter(c => c.trim() !== '').map(c => c.trim());
                if (cells.length > 0) {
                    tableHtml += `<tr>`;
                    cells.forEach(c => { tableHtml += `<td class="px-6 py-4 whitespace-nowrap text-slate-700">${c}</td>`; });
                    tableHtml += `</tr>`;
                }
            });
            tableHtml += `</tbody></table></div>`;
            return tableHtml;
        }

        function processLine(line) {
            if (!line) return '<br class="my-2">';
            if (line.startsWith('### ')) return `<h3 class="text-lg font-bold mt-4 mb-2 text-slate-700 uppercase tracking-wide flex items-center gap-2"><i class="fas fa-chevron-right text-indigo-500 text-sm"></i> ${line.substring(4)}</h3>`;
            if (line.startsWith('## ')) return `<h2 class="text-2xl font-bold mt-6 mb-3 text-slate-800 border-b border-indigo-100 pb-2">${line.substring(3)}</h2>`;
            if (line.startsWith('# ')) return `<div class="bg-indigo-50 p-4 rounded-lg border-l-4 border-indigo-600 mb-6"><h1 class="text-3xl font-bold text-indigo-900">${line.substring(2)}</h1></div>`;
            if (line.match(/^\s*[\-\*]\s+/)) return `<li class="ml-5 list-disc text-slate-600 mb-1 pl-1">${line.replace(/^\s*[\-\*]\s+/, '').replace(/\*\*(.*?)\*\*/g, '<strong class="text-slate-800">$1</strong>')}</li>`;
            let processed = line.replace(/\*\*(.*?)\*\*/g, '<strong class="text-slate-800">$1</strong>').replace(/`([^`]+)`/g, '<code class="bg-slate-100 px-1 rounded text-pink-500 font-mono text-sm">$1</code>');
            return `<p class="mb-3 text-slate-700 leading-relaxed">${processed}</p>`;
        }

        // --- DIRECT TO WINDOW REPORT HANDLER ---
        async function handleGenerateReport(type) {
            if (!window.state.r || !window.state.aR) return;
            const titleMap = { 'owned': 'Solar Asset Transfer Report', 'lease': 'Solar Lease Assumption Report', 'ppa': 'PPA Transfer Analysis Report', 'val': 'Appraisal and FMV Negotiation Report' };
            const reportTitle = titleMap[type] || 'Solar Report';
            
            // 1. OPEN NEW WINDOW IMMEDIATELY (Bypass popup blockers)
            const reportWin = window.open('', '_blank');
            if (!reportWin) {
                showToast("Please allow popups to generate reports.", "warning");
                return;
            }

            // 2. SHOW LOADING STATE IN NEW WINDOW
            reportWin.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>${reportTitle}</title>
                    <script src="https://cdn.tailwindcss.com"><\/script>
                    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
                    <style>body { display: flex; align-items: center; justify-content: center; height: 100vh; background: #f8fafc; color: #4f46e5; font-family: sans-serif; }</style>
                </head>
                <body>
                    <div class="text-center">
                        <i class="fas fa-circle-notch fa-spin text-4xl mb-4"></i>
                        <h2 class="text-xl font-bold">Generating Report...</h2>
                        <p class="text-slate-500">Analyzing system data</p>
                    </div>
                </body>
                </html>
            `);

            const inputs = {
                systemSize: window.state.sz,
                totalCost: window.state.rC * window.state.sz * 1000,
                annualSavings: window.state.r.actSav,
                age: window.state.r.age,
                totalLifetimeSavings: window.state.aR.inc,
                performanceRatio: window.state.r.pr,
                fairMarketValue: window.state.aR.val,
                tpoMonthlyPayment: window.state.pa,
                tpoEscalator: window.state.tEs,
                tpoGuaranteeMWh: window.state.r.guaL,
                tpoActualMWh: window.state.r.act,
                address: window.state.a,
                installDate: window.state.iDt,
                rC: window.state.rC,
                dr: window.state.dr,
                rp: window.state.rp,
                aR: window.state.aR,
                r: window.state.r,
                battery: window.state.b,
                utilityRate: window.state.ut,
                inverterType: window.state.it,
                condition: window.state.c,
                usefulLife: window.state.l,
                repairs: window.state.rp
            };

            let finalContent = "";
            let citations = [];

            try {
                if (window.state.reportMode === 'standard') {
                    finalContent = generateStandardReport(type, inputs);
                } else {
                    // AI Report Logic
                    const { systemPrompt, userQuery } = buildPrompt(type, inputs);
                    const payload = { contents: [{ parts: [{ text: userQuery }] }], systemInstruction: { parts: [{ text: systemPrompt }] } };
                    
                    // SAFEGUARD: Ensure options are valid before calling fetch
                    const options = { 
                        method: 'POST', 
                        headers: { 'Content-Type': 'application/json' }, 
                        body: JSON.stringify(payload) 
                    };
                    
                    const result = await fetchWithExponentialBackoff(API_URL, options);
                    const candidate = result.candidates?.[0];
                    if (!candidate || !candidate.content?.parts?.[0]?.text) { throw new Error("API returned an invalid response."); }
                    finalContent = `<div class="prose prose-sm max-w-none text-slate-700">${parseMarkdown(candidate.content.parts[0].text)}</div>`;
                    if (candidate.groundingMetadata?.groundingAttributions) {
                        citations = candidate.groundingMetadata.groundingAttributions.map(a => ({ uri: a.web?.uri, title: a.web?.title })).filter(s => s.uri);
                    }
                }

                // 3. INJECT FINAL CONTENT
                const citationHtml = citations.length > 0 ? `<div class="mt-8 pt-4 border-t border-gray-100"><p class="text-xs font-bold text-slate-600 mb-1">Sources:</p><ul class="text-[10px] text-indigo-500">${citations.map(s => `<li><a href="${s.uri}" target="_blank">${s.title}</a></li>`).join('')}</ul></div>` : '';

                // SCRIPT CONTENT - Direct functions are robust against DOM ready issues in popups
                const safeTitle = reportTitle.replace(/\s+/g, '_');
                const scriptContent = `
                    function downloadReport() {
                        try {
                            const html = document.documentElement.outerHTML;
                            const blob = new Blob([html], { type: 'text/html' });
                            const url = URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = '${safeTitle}.html';
                            document.body.appendChild(a);
                            a.click();
                            setTimeout(() => { 
                                document.body.removeChild(a); 
                                window.URL.revokeObjectURL(url); 
                            }, 100);
                        } catch(err) {
                            alert("Download failed: " + err.message);
                        }
                    }
                `;

                reportWin.document.open();
                reportWin.document.write(`
                    <!DOCTYPE html>
                    <html lang="en">
                    <head>
                        <meta charset="UTF-8">
                        <title>${reportTitle}</title>
                        <script src="https://cdn.tailwindcss.com"><\/script>
                        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
                        <style>
                            body { background-color: #f8fafc; font-family: sans-serif; padding: 40px; padding-bottom: 80px; }
                            .report-container { max-width: 900px; margin: 0 auto; background: white; padding: 40px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
                            @media print { 
                                .no-print { display: none !important; } 
                                body { padding: 0; background: white; }
                                .report-container { box-shadow: none; max-width: 100%; padding: 0; }
                            }
                        </style>
                        <script>${scriptContent}<\/script>
                    </head>
                    <body>
                        <div class="report-container">
                            <div class="border-b border-slate-200 pb-4 mb-6 flex justify-between items-start">
                                <div><h3 class="text-xl font-bold text-indigo-900">${reportTitle}</h3><p class="text-xs text-slate-500 mt-1">${new Date().toLocaleDateString()}</p></div>
                                <div class="text-2xl text-yellow-500"><i class="fas fa-sun"></i></div>
                            </div>
                            ${finalContent}
                            ${citationHtml}
                        </div>

                        <!-- FIXED TOOLBAR -->
                        <div class="fixed bottom-0 left-0 right-0 bg-white border-t p-4 flex justify-end gap-2 no-print shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] z-50">
                            <button onclick="window.print()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded text-sm font-bold mr-2 flex items-center gap-2"><i class="fas fa-print"></i> Print</button>
                            <button onclick="downloadReport()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm font-bold mr-2 flex items-center gap-2"><i class="fas fa-download"></i> Download HTML</button>
                            <button onclick="window.close()" class="border border-slate-300 hover:bg-slate-50 text-slate-700 px-4 py-2 rounded text-sm font-bold">Close</button>
                        </div>
                    </body>
                    </html>
                `);
                reportWin.document.close();
                setTimeout(() => reportWin.focus(), 500); // Ensure focus for print

            } catch (error) {
                reportWin.document.body.innerHTML = `<div style="padding:40px; color:red; text-align:center;"><h3>Generation Failed</h3><p>${error.message}</p></div>`;
            }
        };

        // --- STANDARD REPORT GENERATOR (Local, Rich HTML) ---
        function generateStandardReport(type, inputs) {
            const { systemSize, annualSavings, age, fairMarketValue, tpoMonthlyPayment, tpoEscalator, tpoGuaranteeMWh, tpoActualMWh, address, installDate, performanceRatio, totalLifetimeSavings, battery, inverterType, condition, utilityRate, repairs, r, aR } = inputs;
            const date = new Date().toLocaleDateString();
            
            // Logic needed for visuals
            let invStatus, invColor, invTextColor, invMsg, invLife;
            if (inverterType === 'string') { invLife = 15; if (age < 8) { invStatus = 'Good Condition'; invColor = 'bg-green-500'; invTextColor = 'text-green-600'; invMsg = 'Within standard warranty period.'; } else if (age < 10) { invStatus = 'Warranty Expiring'; invColor = 'bg-orange-500'; invTextColor = 'text-orange-600'; invMsg = 'Reaching the end of warranted life.'; } else { invStatus = 'Action Required'; invColor = 'bg-red-500'; invTextColor = 'text-red-600'; invMsg = 'Inverter will likely need to be replaced soon.'; } } else { invLife = 30; if (age < 20) { invStatus = 'Good Condition'; invColor = 'bg-green-500'; invTextColor = 'text-green-600'; invMsg = 'Within standard warranty period.'; } else if (age < 25) { invStatus = 'Warranty Expiring'; invColor = 'bg-orange-500'; invTextColor = 'text-orange-600'; invMsg = 'Reaching the end of warranted life.'; } else { invStatus = 'Action Required'; invColor = 'bg-red-500'; invTextColor = 'text-red-600'; invMsg = 'Inverter will likely need to be replaced soon.'; } }
            const invLabel = inverterType === 'micro' ? 'Microinverters' : 'String Inverter';
            
            let panelStatus, panelColor, panelTextColor, panelMsg;
            if (age < 15) { panelStatus = 'Good Condition'; panelColor = 'bg-blue-500'; panelTextColor = 'text-blue-600'; panelMsg = 'Operating within standard efficiency range.'; } else if (age < 20) { panelStatus = 'Degradation Visible'; panelColor = 'bg-orange-500'; panelTextColor = 'text-orange-600'; panelMsg = 'Efficiency dropping. Nearing optimal life end.'; } else { panelStatus = 'Replacement Due'; panelColor = 'bg-red-500'; panelTextColor = 'text-red-600'; panelMsg = 'Passed 20-year optimal lifespan. Plan for upgrade.'; }
            
            // VALUATION SPECIFIC HEADER
            let header = `<div class="font-sans text-slate-800">
                <div class="mb-6 border-b-2 border-slate-800 pb-4">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-end gap-4">
                        <div>
                            <h1 class="text-2xl md:text-3xl font-black text-slate-900 uppercase tracking-tight">Fair Market Value</h1>
                            <p class="text-slate-500 text-sm font-bold uppercase tracking-widest mt-1">Solar System Appraisal Report</p>
                        </div>
                        <div class="text-left md:text-right">
                            <p class="text-sm font-bold text-slate-900">${date}</p>
                            <p class="text-xs text-slate-500">${address || "Solar Property"}</p>
                        </div>
                    </div>
                </div>`;

            let body = `<div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">`;

            // --- CARDS SECTION (Shared) ---
            if (type !== 'val') {
                 // For Owned/Lease/PPA, use the standard simple header
                 header = `<div class="font-sans text-slate-800">
                    <div class="mb-6 border-b pb-4">
                        <h2 class="text-xl md:text-2xl font-bold text-slate-900">${address || "Solar Property"}</h2>
                        <p class="text-slate-500 text-sm">Report Date: ${date}</p>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">`;
                 // Card 1: System Profile (Always included for non-val)
                 body = C("System Profile", "System capacity and age snapshot.", `
                    <div class="grid grid-cols-2 gap-4 pt-2">
                        <div><p class="text-xs uppercase text-slate-500 font-bold">Rated Size</p><p class="text-2xl md:text-3xl font-black text-blue-800">${systemSize.toFixed(2)} kW</p><p class="text-xs text-slate-400">Total DC Power</p></div>
                        <div class="border-l pl-4"><p class="text-xs uppercase text-slate-500 font-bold">Age</p><p class="text-2xl md:text-3xl font-black text-blue-800">${age.toFixed(1)} <span class="text-sm font-normal text-slate-500">Years</span></p><p class="text-xs text-slate-400">Years since install</p></div>
                        <div class="col-span-2 border-t pt-2 grid grid-cols-2 gap-4">
                            <div><p class="text-xs text-slate-500">Est. Next 12 Mo</p><p class="text-xl md:text-2xl font-bold text-slate-700">${num(r.estN12 / 1000)} MWh</p></div>
                            <div class="border-l pl-4"><p class="text-xs text-slate-500">Lifetime Output</p><p class="text-xl md:text-2xl font-bold text-slate-700">${num(r.act / 1000)} GWh</p></div>
                        </div>
                    </div>`, 'text-blue-700');
            } else {
                body = ''; // Valuation uses custom layout below
            }

            if (type === 'owned') {
                body += C("Performance Summary", "Actual production vs expected output for age.", `
                    <div class="mb-4 mt-2">
                        <div class="flex justify-between text-xs font-bold mb-3"><span class="${r.pr >= 0.9 ? "text-green-600" : "text-red-600"}">${r.pr >= 0.9 ? "OPTIMIZED" : "UNDERPERFORMING"}</span></div>
                        <div class="relative w-full">
                            <div class="absolute bottom-full left-[90%] -translate-x-1/2 mb-1 text-[9px] font-bold text-slate-400 whitespace-nowrap">Goal: 90%</div>
                            <div class="w-full bg-slate-100 h-3 rounded-full overflow-hidden relative">
                                <div class="absolute h-full w-0.5 bg-slate-400 left-[90%] z-10"></div>
                                <div class="h-full ${r.pr >= 0.9 ? 'bg-green-500' : 'bg-red-500'}" style="width:${Math.min(r.pr * 100, 100)}%"></div>
                            </div>
                        </div>
                    </div>
                    ${R("Performance Ratio", per(r.pr), "", "Current Efficiency")}
                    ${R("Expected Output", num(r.physLifeMwh), "MWh", "Modeled Target")}
                `, r.pr >= 0.9 ? "text-green-600" : "text-red-600");

                body += C("Equipment Health", "Estimated remaining life.", `
                    <div class="space-y-4">
                        <div>
                            <div class="flex justify-between text-sm mb-1 font-bold"><span class="text-slate-600">${invLabel}</span><span class="${invTextColor}">${invStatus}</span></div>
                            <div class="w-full bg-slate-100 h-2 rounded-full"><div class="h-2 rounded-full ${invColor}" style="width:${Math.min(age / invLife * 100, 100)}%"></div></div>
                        </div>
                        <div>
                            <div class="flex justify-between text-sm mb-1 font-bold"><span class="text-slate-600">Solar Panels</span><span class="${panelTextColor}">${panelStatus}</span></div>
                            <div class="w-full bg-slate-100 h-2 rounded-full"><div class="${panelColor} h-2 rounded-full" style="width:${((100 - (age * 0.5)) * r.pr)}%"></div></div>
                        </div>
                    </div>
                `, 'text-slate-700', '', '<i class="fas fa-heart-pulse mr-2 text-red-400"></i>');

                body += C("Financial Value", "Energy savings analysis.", `
                    <div class="grid grid-cols-2 gap-4 mb-2">
                        <div><p class="text-xs font-bold text-slate-400">Annual Savings</p><p class="text-xl font-black text-green-700">${cur(annualSavings)}</p></div>
                        <div><p class="text-xs font-bold text-slate-400">Lifetime Value</p><p class="text-xl font-black text-slate-700">${cur(totalLifetimeSavings)}</p></div>
                    </div>
                    <p class="text-xs text-slate-500 mt-2">Based on current utility rates.</p>
                `, 'text-green-700');
            } else if (type === 'lease' || type === 'ppa') {
                const tpoGuarLabel = type === 'lease' ? 'Guaranteed Min' : 'Contract Est.';
                body += C(type === "lease" ? "Lease Guarantee" : "PPA Performance", "Contractual obligation status.", `
                    <div class="mb-4">${R("Actual Lifetime", num(r.act), "MWh")}${R(tpoGuarLabel, num(r.guaL), "MWh")}</div>
                    <div class="p-3 rounded-lg border-2 flex items-center gap-3 ${r.gDiff >= 0 ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'}">
                        <span class="text-2xl">${r.gDiff >= 0 ? '✅' : '⚠️'}</span>
                        <div><div class="text-lg font-black uppercase ${r.gDiff >= 0 ? 'text-green-800' : 'text-red-800'}">${r.gDiff >= 0 ? 'PASSING' : 'FAILING'}</div>${r.gDiff < 0 ? `<div class="text-xs font-bold text-red-600">Claim Available</div>` : ''}</div>
                    </div>
                `, 'text-slate-700');

                body += C("Contract Financials", "Payment schedule overview.", `
                    <div class="flex justify-between items-end border-b pb-2 mb-2">
                        <div><p class="text-xs font-bold text-slate-400">Current Payment</p><p class="text-2xl font-black text-slate-700">${type === 'lease' ? cur(tpoMonthlyPayment) + '/mo' : '$' + tpoMonthlyPayment.toFixed(3) + '/kWh'}</p></div>
                        <div class="text-right"><p class="text-xs font-bold text-slate-400">Escalator</p><p class="text-xl font-bold text-red-600">${tpoEscalator}%</p></div>
                    </div>
                    ${type === 'lease' ? `<p class="text-xs text-slate-500">Total Remaining Payments: <strong>${cur(r.tCost)}</strong></p>` : ''}
                `, 'text-slate-700');
            }

            if (type !== 'val') body += `</div>`; // Close grid for non-val

            // --- NARRATIVE SECTION ---
            let narrative = '';
            if (type === 'owned') {
                narrative = `<div class="prose prose-sm max-w-none text-slate-700 bg-slate-50 p-6 rounded-xl border border-slate-200">
                <h3 class="text-indigo-900 mt-0">Consultant Analysis</h3>
                <p><strong>1. Financial Value:</strong> This system provides an estimated annual savings of <strong>${cur(annualSavings)}</strong>. Over the remaining life of the system, it is projected to generate <strong>${cur(totalLifetimeSavings)}</strong> in total value compared to standard utility rates.</p>
                <p><strong>2. System Health:</strong> The Performance Ratio (PR) is <strong>${per(performanceRatio)}</strong>. A PR above 90% indicates the system is performing optimally. ${performanceRatio < 0.9 ? "This system is showing signs of degradation or shading issues that should be investigated." : "The system is converting sunlight to electricity efficiently."}</p>
                <p><strong>3. Lifecycle & Durability:</strong> At <strong>${age.toFixed(1)} years old</strong>, the system is in the ${age < 10 ? "early" : age < 20 ? "mid" : "late"} stage of its lifecycle. ${battery > 0 ? `It includes a <strong>${battery}kWh battery</strong> which adds resilience but may require maintenance sooner than the panels.` : "It is a standard grid-tied PV system with high durability."} The ${invLabel} is currently in <strong>${invStatus}</strong>.</p>
                </div>`;
            } else if (type === 'lease') {
                narrative = `<div class="prose prose-sm max-w-none text-slate-700 bg-slate-50 p-6 rounded-xl border border-slate-200">
                <h3 class="text-indigo-900 mt-0">Consultant Analysis</h3>
                <p><strong>1. "Solar-as-a-Service":</strong> This property benefits from a solar lease. The homeowner pays a fixed monthly amount of <strong>${cur(tpoMonthlyPayment)}</strong>, while the solar provider handles maintenance and repairs.</p>
                <p><strong>2. Cost vs Utility:</strong> While the lease payment increases by <strong>${tpoEscalator}% annually</strong>, utility rates often rise faster (typically 4-6% per year). This gap generates the savings.</p>
                <p><strong>3. Production Guarantee:</strong> The system has produced <strong>${num(r.act)} MWh</strong>, compared to a guaranteed minimum of <strong>${num(r.guaL)} MWh</strong>. ${r.gDiff >= 0 ? "The system is overproducing, providing extra value at no extra cost." : "The system is underperforming. You may be entitled to a performance payment from the leasing company."}</p>
                </div>`;
            } else if (type === 'ppa') {
                narrative = `<div class="prose prose-sm max-w-none text-slate-700 bg-slate-50 p-6 rounded-xl border border-slate-200">
                <h3 class="text-indigo-900 mt-0">Consultant Analysis</h3>
                <p><strong>1. PPA Model (Pay-for-Performance):</strong> Unlike a lease with a fixed bill, this PPA charges you only for the energy actually produced, currently at a rate of <strong>$${tpoMonthlyPayment.toFixed(3)}/kWh</strong>. This should be compared against the local utility rate of <strong>$${utilityRate === 'nem2' || utilityRate === 'nem3' ? '0.35-0.50' : '0.15-0.25'}/kWh</strong>.</p>
                <p><strong>2. Performance Obligation:</strong> The provider is incentivized to keep the system running, as they only get paid when it produces power.</p>
                </div>`;
            } else if (type === 'val') {
                // PROFESSIONAL VALUATION CONTENT - EXPANDED BASED ON USPAP & INCOME CAP
                narrative = `
                <div class="mb-8">
                    <h3 class="text-lg font-bold text-slate-900 border-b border-slate-200 pb-2 mb-4">Executive Summary</h3>
                    <p class="mb-4">This valuation report provides an independent estimate of the Fair Market Value (FMV) of the residential photovoltaic (PV) solar system installed at the subject property. The valuation assumes a transaction between a well-informed buyer and seller in an open market.</p>
                    
                    <div class="bg-slate-50 p-4 rounded-xl border border-slate-200 mb-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-center">
                            <div>
                                <p class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">Conclusion of Value</p>
                                <p class="text-4xl font-extrabold text-slate-900">${cur(fairMarketValue)}</p>
                                <p class="text-sm text-slate-600 mt-1">Effective Date: ${date}</p>
                            </div>
                            <div class="text-sm text-slate-700 border-l pl-6 border-slate-300">
                                <p><strong>System Size:</strong> ${systemSize.toFixed(2)} kW DC</p>
                                <p><strong>Remaining Useful Life:</strong> ${inputs.usefulLife} Years</p>
                                <p><strong>Valuation Method:</strong> ${window.state.mt === 'Blended' ? 'Weighted Blended Approach' : window.state.mt + ' Approach'}</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mb-8">
                    <h3 class="text-lg font-bold text-slate-900 border-b border-slate-200 pb-2 mb-4">Valuation Methodology & Standards</h3>
                    
                    <div class="prose prose-sm text-slate-700 max-w-none">
                        <p>This appraisal methodology follows the general principles of the <strong>Uniform Standards of Professional Appraisal Practice (USPAP)</strong>, the recognized ethical and performance standards for the appraisal profession in the United States.</p>
                        
                        <h4 class="font-bold text-slate-900 mt-4">1. Income Capitalization Approach</h4>
                        <p>The Income Approach is the primary method for valuing income-generating assets. It calculates the <strong>Present Value (PV)</strong> of the future stream of economic benefits (energy savings) expected to be generated by the System.</p>
                        <ul class="list-disc pl-5 space-y-1">
                            <li><strong>Revenue Stream:</strong> Projected based on the system's energy production and the avoided cost of utility electricity, escalated annually at <strong>${inputs.e}%</strong>.</li>
                            <li><strong>Operating Expenses:</strong> Includes estimates for Operation & Maintenance (O&M) and future inverter replacement reserves.</li>
                            <li><strong>Discount Rate:</strong> A risk-adjusted discount rate of <strong>${inputs.dr}%</strong> is applied to future cash flows to account for the time value of money and investment risk.</li>
                        </ul>

                        <h4 class="font-bold text-slate-900 mt-4">2. Cost Approach</h4>
                        <p>The Cost Approach estimates the value based on the current cost to reproduce or replace the system with a modern equivalent, adjusted for physical deterioration and obsolescence.</p>
                        <ul class="list-disc pl-5 space-y-1">
                            <li><strong>Replacement Cost New (RCN):</strong> Current market rate for a comparable ${systemSize.toFixed(2)} kW system.</li>
                            <li><strong>Depreciation:</strong> Deductions for physical age (${age.toFixed(1)} years) and functional obsolescence.</li>
                        </ul>
                    </div>
                </div>

                <div class="mb-8">
                    <h3 class="text-lg font-bold text-slate-900 border-b border-slate-200 pb-2 mb-4">Valuation Calculation Summary</h3>
                    <div class="overflow-hidden rounded-lg border border-slate-200">
                        <div class="overflow-x-auto">
                            <table class="min-w-full text-sm">
                                <thead class="bg-slate-100 text-slate-700 font-bold">
                                    <tr>
                                        <th class="py-3 px-4 text-left">Approach</th>
                                        <th class="py-3 px-4 text-right">Indicated Value</th>
                                        <th class="py-3 px-4 text-right">Weight Applied</th>
                                        <th class="py-3 px-4 text-right">Weighted Value</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-100">
                                    <tr>
                                        <td class="py-3 px-4">Income Capitalization</td>
                                        <td class="py-3 px-4 text-right font-medium">${cur(aR.inc)}</td>
                                        <td class="py-3 px-4 text-right text-slate-500">${window.state.w}%</td>
                                        <td class="py-3 px-4 text-right text-slate-500">${cur(aR.inc * (window.state.w/100))}</td>
                                    </tr>
                                    <tr>
                                        <td class="py-3 px-4">Cost (Depreciated Replacement)</td>
                                        <td class="py-3 px-4 text-right font-medium">${cur(aR.cost)}</td>
                                        <td class="py-3 px-4 text-right text-slate-500">${(100 - window.state.w)}%</td>
                                        <td class="py-3 px-4 text-right text-slate-500">${cur(aR.cost * ((100 - window.state.w)/100))}</td>
                                    </tr>
                                    <tr class="bg-indigo-50 font-bold text-indigo-900">
                                        <td class="py-4 px-4">Final FMV Estimate</td>
                                        <td class="py-4 px-4 text-right"></td>
                                        <td class="py-4 px-4 text-right">100%</td>
                                        <td class="py-4 px-4 text-right">${cur(fairMarketValue)}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="mb-8">
                    <h3 class="text-lg font-bold text-slate-900 border-b border-slate-200 pb-2 mb-4">Key Technical Inputs</h3>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-y-4 gap-x-8 text-sm">
                        <div class="border-b border-slate-100 pb-2">
                            <span class="block text-slate-400 text-xs uppercase font-bold">System Size</span>
                            <span class="block text-slate-900 font-medium">${systemSize.toFixed(2)} kW DC</span>
                        </div>
                        <div class="border-b border-slate-100 pb-2">
                            <span class="block text-slate-400 text-xs uppercase font-bold">Installation Year</span>
                            <span class="block text-slate-900 font-medium">${new Date(installDate).getFullYear()} (Age: ${age.toFixed(1)} yrs)</span>
                        </div>
                        <div class="border-b border-slate-100 pb-2">
                            <span class="block text-slate-400 text-xs uppercase font-bold">Utility Rate Schedule</span>
                            <span class="block text-slate-900 font-medium uppercase">${utilityRate}</span>
                        </div>
                        <div class="border-b border-slate-100 pb-2">
                            <span class="block text-slate-400 text-xs uppercase font-bold">Condition Factor</span>
                            <span class="block text-slate-900 font-medium">${condition.toFixed(2)} (${condition > 0.9 ? 'Excellent' : 'Average'})</span>
                        </div>
                        <div class="border-b border-slate-100 pb-2">
                            <span class="block text-slate-400 text-xs uppercase font-bold">Discount Rate</span>
                            <span class="block text-slate-900 font-medium">${inputs.dr}%</span>
                        </div>
                        <div class="border-b border-slate-100 pb-2">
                            <span class="block text-slate-400 text-xs uppercase font-bold">Est. Repairs Needed</span>
                            <span class="block text-red-600 font-medium">${cur(repairs)}</span>
                        </div>
                    </div>
                </div>

                <div class="mt-8 p-4 bg-slate-100 rounded-lg border border-slate-300">
                    <h4 class="text-sm font-bold text-slate-800 uppercase mb-2"><i class="fas fa-clipboard-check mr-2 text-indigo-600"></i>Methodology & Inspection Certification</h4>
                    <p class="text-xs text-slate-600 leading-relaxed">
                        Unlike automated "desktop valuations" utilized by many leasing companies which rely on statistical averages and theoretical assumptions (often assuming a 35-year life span to inflate value), this appraisal is based on a verifiable <strong>Physical Site Inspection</strong>. System condition, actual shading, and specific equipment health have been visually verified by a solar professional, ensuring a valuation that reflects the true asset condition rather than a generic model.
                    </p>
                </div>

                <div class="text-xs text-slate-500 mt-12 pt-6 border-t border-slate-300">
                    <p class="font-bold uppercase mb-2 text-slate-700">Statement of Limiting Conditions</p>
                    <p>This report is an estimate of Fair Market Value based on the "Income Capitalization Approach" and "Cost Approach". The results rely on data provided by the user and industry-standard assumptions regarding degradation, utility rate escalation, and equipment longevity. This report does not constitute a structural engineering certification or a guarantee of future energy production. Actual market value may be influenced by local real estate conditions, specific buyer motivations, and changes in utility regulations. This valuation is intended for informational purposes to assist in real estate transactions or asset transfer assessments.</p>
                </div>
                `;
            }

            return header + body + narrative + `</div>`;
        }

        // --- 5. Render Helpers (UPDATED FOR LARGER FONTS) ---
        function I(l, v, key, t = "number", d, st = "0.01", disabled = false, handler = "handleInputChange") {
            return `<div class=""><label for="${key}" class="block text-slate-500 text-xs sm:text-sm mb-1 font-bold uppercase tracking-wider">${l}</label><input type="${t}" step="${st}" id="${key}" class="w-full p-2 border border-slate-200 rounded text-slate-800 text-base font-semibold focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-shadow ${disabled ? 'bg-slate-100 text-slate-400' : 'bg-white'}" value="${v}" ${disabled ? 'disabled' : ''} onchange="${handler}(event,'${key}')"/><p class="text-xs text-slate-400 mt-1 leading-tight">${d || ''}</p></div>`;
        }
        function Idark(l, v, key, t = "number", d, st = "0.01", disabled = false) {
             return `<div class=""><label for="${key}" class="block text-blue-200 text-xs sm:text-sm mb-1 font-bold uppercase tracking-wider">${l}</label><input type="${t}" step="${st}" id="${key}" class="w-full p-2 border border-slate-500 rounded bg-slate-700/50 text-white text-base font-semibold focus:ring-2 focus:ring-blue-400 focus:border-blue-400 placeholder-slate-400 backdrop-blur-sm ${disabled ? 'opacity-50 cursor-not-allowed' : ''}" value="${v}" ${disabled ? 'disabled' : ''} onchange="handleInputChange(event,'${key}')"/><p class="text-xs text-slate-400 mt-1 leading-tight">${d || ''}</p></div>`;
        }
        function Sdark(l, v, key, o, d) {
            return `<div class=""><label for="${key}" class="block text-blue-200 text-xs sm:text-sm mb-1 font-bold uppercase tracking-wider">${l}</label><select id="${key}" class="w-full p-2 border border-slate-500 rounded bg-slate-700/50 text-white text-base font-semibold focus:ring-2 focus:ring-blue-400 focus:border-blue-400 backdrop-blur-sm" onchange="handleInputChange(event,'${key}')">${o.map(x => `<option value="${x.v}" ${v == x.v ? 'selected' : ''}>${x.l}</option>`).join('')}</select><p class="text-xs text-slate-400 mt-1 leading-tight">${d || ''}</p></div>`;
        }
        function S(l, v, key, o, d) {
            return `<div class=""><label for="${key}" class="block text-slate-500 text-xs sm:text-sm mb-1 font-bold uppercase tracking-wider">${l}</label><select id="${key}" class="w-full p-2 border border-slate-200 rounded text-slate-800 text-base font-semibold focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white" onchange="handleInputChange(event,'${key}')">${o.map(x => `<option value="${x.v}" ${v == x.v ? 'selected' : ''}>${x.l}</option>`).join('')}</select><p class="text-xs text-slate-400 mt-1 leading-tight">${d || ''}</p></div>`;
        }
        function R(l, v, s, d) {
            return `<div class="mb-3 border-b border-slate-100 pb-2 last:border-0 last:pb-0"><div class="flex justify-between items-center text-sm sm:text-base"><span class="font-bold text-slate-600">${l}</span><span class="font-bold text-slate-800 text-base sm:text-lg">${v} <span class="text-xs sm:text-sm text-slate-500 font-normal">${s}</span></span></div>${d ? `<p class="text-xs text-slate-400 leading-tight mt-0.5">${d}</p>` : ''}</div>`;
        }
        function C(t, d, children, c = 'text-slate-700', cl = '', icon = '') {
            let iconHtml = '';
            if (t.includes("Profile")) iconHtml = '<i class="fas fa-solar-panel mr-2 text-blue-500"></i>';
            if (t.includes("Performance")) iconHtml = '<i class="fas fa-chart-line mr-2 text-green-500"></i>';
            if (t.includes("Savings")) iconHtml = '<i class="fas fa-sack-dollar mr-2 text-emerald-600"></i>';
            if (t.includes("Warranty")) iconHtml = '<i class="fas fa-shield-halved mr-2 text-indigo-500"></i>';
            if (t.includes("Cost Approach")) iconHtml = '<i class="fas fa-hammer mr-2 text-slate-400"></i>';
            if (t.includes("Income Approach")) iconHtml = '<i class="fas fa-money-bill-trend-up mr-2 text-green-400"></i>';
            return `<div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm hover:shadow-md transition-shadow duration-300 h-full break-inside-avoid ${cl}"><div class="border-b border-slate-100 pb-3 mb-4"><h3 class="text-xl font-bold flex items-center ${c}">${iconHtml}${t}</h3>${d ? `<p class="text-sm text-slate-400 mt-1 font-medium">${d}</p>` : ''}</div>${children}</div>`;
        }
        function LC(data) {
            if (!data || data.length === 0) return '';
            const w = 600, h = 200, p = 20;
            const mV = Math.max(...data.map(x => x.c));
            const pts = data.map((d, i) => {
                const x = p + (i / (data.length - 1)) * (w - 2 * p);
                const y = h - p - (d.c / mV) * (h - 2 * p);
                return `${x},${y}`;
            }).join(' ');
            const gradId = "grad" + Math.floor(Math.random() * 1000);
            return `<div class="w-full h-32 mt-4"><svg viewBox="0 0 ${w} ${h}" width="100%" height="100%" class="overflow-visible"><defs><linearGradient id="${gradId}" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" style="stop-color:#22c55e;stop-opacity:0.2" /><stop offset="100%" style="stop-color:#22c55e;stop-opacity:0" /></linearGradient></defs><path d="M ${p},${h - p} ${pts.split(' ').map((pt, i) => `L ${pt}`).join(' ')} L ${w - p},${h - p} Z" fill="url(#${gradId})" /><polyline points="${pts}" fill="none" stroke="#16a34a" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/><line x1="${p}" y1="${h-p}" x2="${w-p}" y2="${h-p}" stroke="#e2e8f0" stroke-width="1" /><text x="${w - p}" y="${h}" font-size="10" fill="#94a3b8" text-anchor="end" font-family="sans-serif">End of Life</text><text x="${p}" y="${h}" font-size="10" fill="#94a3b8" text-anchor="start" font-family="sans-serif">Now</text></svg></div>`;
        }

        function render() {
            // Updated to include reportTitle, isLoading, dynReport, and citations
            const { activeTab, activeModal, o, sz, r, aR, a, iDt, pDt, ac, pC, pW, b, it, ut, or, pi, sh, tE, tG, tEs, pa, tR, rR, rC, ne, c, l, om, dr, rp, tx, mt, e, w, te, reportTitle, reportMode } = window.state;
            const root = document.getElementById('root');
            
            // Logic for Visuals
            let invStatus, invColor, invTextColor, invMsg, invLife;
            if (it === 'string') { invLife = 15; if (r && r.age < 8) { invStatus = 'Good Condition'; invColor = 'bg-green-500'; invTextColor = 'text-green-600'; invMsg = 'Within standard warranty period.'; } else if (r && r.age < 10) { invStatus = 'Warranty Expiring'; invColor = 'bg-orange-500'; invTextColor = 'text-orange-600'; invMsg = 'Reaching the end of warranted life.'; } else { invStatus = 'Action Required'; invColor = 'bg-red-500'; invTextColor = 'text-red-600'; invMsg = 'Inverter will likely need to be replaced soon.'; } } else { invLife = 30; if (r && r.age < 20) { invStatus = 'Good Condition'; invColor = 'bg-green-500'; invTextColor = 'text-green-600'; invMsg = 'Within standard warranty period.'; } else if (r && r.age < 25) { invStatus = 'Warranty Expiring'; invColor = 'bg-orange-500'; invTextColor = 'text-orange-600'; invMsg = 'Reaching the end of warranted life.'; } else { invStatus = 'Action Required'; invColor = 'bg-red-500'; invTextColor = 'text-red-600'; invMsg = 'Inverter will likely need to be replaced soon.'; } }
            const invLabel = it === 'micro' ? 'Microinverters' : 'String Inverter';
            let panelStatus, panelColor, panelTextColor, panelMsg;
            if (r) { if (r.age < 15) { panelStatus = 'Good Condition'; panelColor = 'bg-blue-500'; panelTextColor = 'text-blue-600'; panelMsg = 'Operating within standard efficiency range.'; } else if (r.age < 20) { panelStatus = 'Degradation Visible'; panelColor = 'bg-orange-500'; panelTextColor = 'text-orange-600'; panelMsg = 'Efficiency dropping. Nearing optimal life end.'; } else { panelStatus = 'Replacement Due'; panelColor = 'bg-red-500'; panelTextColor = 'text-red-600'; panelMsg = 'Passed 20-year optimal lifespan. Plan for upgrade.'; } }
            let tpoGuarLabel = o === 'lease' ? 'Guaranteed Min' : 'Contract Est. kWh';

            // --- NEW: Lease/PPA Assessment Logic ---
            let leaseAssessment = "";
            if (r) {
                 const isGuaranteed = r.guaL > 0;
                 const act = r.act;
                 const est = r.estLifeMwh;
                 const gua = r.guaL;
                 
                 if (isGuaranteed) {
                    if (act >= est) {
                        leaseAssessment = `<div class="mt-4 p-3 rounded-lg border bg-green-50 text-green-800 border-green-200 flex gap-3 items-start"><i class="fas fa-trophy mt-1 text-green-600"></i><div class="text-xs font-bold"><span class="uppercase block text-[10px] text-green-600 mb-1">Performance Status</span>System is performing excellently, exceeding both the original sales estimate and the guaranteed minimum.</div></div>`;
                    } else if (act >= gua) {
                         leaseAssessment = `<div class="mt-4 p-3 rounded-lg border bg-blue-50 text-blue-800 border-blue-200 flex gap-3 items-start"><i class="fas fa-check-double mt-1 text-blue-600"></i><div class="text-xs font-bold"><span class="uppercase block text-[10px] text-blue-600 mb-1">Contract Compliant</span>System is meeting the mandatory guarantee, despite performing below the initial sales estimate.</div></div>`;
                    } else {
                         leaseAssessment = `<div class="mt-4 p-3 rounded-lg border bg-red-50 text-red-800 border-red-200 flex gap-3 items-start"><i class="fas fa-circle-exclamation mt-1 text-red-600"></i><div class="text-xs font-bold"><span class="uppercase block text-[10px] text-red-600 mb-1">Underperforming</span>System is failing to meet the contractual guarantee. A performance claim should be filed.</div></div>`;
                    }
                 } else {
                    if (act >= est) {
                         leaseAssessment = `<div class="mt-4 p-3 rounded-lg border bg-green-50 text-green-800 border-green-200 flex gap-3 items-start"><i class="fas fa-check-circle mt-1 text-green-600"></i><div class="text-xs font-bold"><span class="uppercase block text-[10px] text-green-600 mb-1">Good Standing</span>System is performing above the original sales estimate.</div></div>`;
                    } else {
                         leaseAssessment = `<div class="mt-4 p-3 rounded-lg border bg-amber-50 text-amber-800 border-amber-200 flex gap-3 items-start"><i class="fas fa-triangle-exclamation mt-1 text-amber-600"></i><div class="text-xs font-bold"><span class="uppercase block text-[10px] text-amber-600 mb-1">Below Estimate</span>System is producing less than originally estimated.</div></div>`;
                    }
                 }
            }

            // --- HTML TEMPLATE START ---
            let html = `
            <div class="min-h-screen bg-slate-50 font-sans pb-10">
                <!-- HEADER -->
                <div class="bg-[#005088] text-white p-3 sticky top-0 z-50 flex justify-between items-center shadow-md no-print">
                    <div class="flex items-center gap-2">
                        <span class="text-2xl"><i class="fas fa-sun text-yellow-400"></i></span>
                        <div><h1 class="font-bold leading-tight text-base sm:text-lg">SolarCheck</h1><p class="text-xs opacity-80 font-medium">Pro v6.2</p></div>
                    </div>
                    <div class="flex gap-2">
                         <button onclick="openModal('print-modal')" class="bg-yellow-400 hover:bg-yellow-300 text-black px-3 py-2 rounded-lg font-bold text-xs sm:text-sm shadow transition-colors flex items-center gap-1"><i class="fas fa-file-pdf"></i> Reports</button>
                         <button onclick="window.open(window.location.href, '_blank')" class="bg-indigo-500 hover:bg-indigo-400 text-white px-3 py-2 rounded-lg font-bold text-xs sm:text-sm shadow transition-colors flex items-center gap-1" title="Open Full Screen"><i class="fas fa-expand"></i></button>
                    </div>
                </div>

                <!-- TAB NAVIGATION (Updated Padding) -->
                <div class="bg-white border-b border-slate-200 sticky top-14 z-40 shadow-sm px-4 flex gap-1 pt-2 no-print overflow-x-auto">
                    <button onclick="updateState('activeTab', 'inputs')" class="flex-1 py-3 border-b-2 font-bold text-sm sm:text-base transition-colors ${activeTab === 'inputs' ? 'border-[#005088] text-[#005088]' : 'border-transparent text-slate-400 hover:text-slate-600'}">
                        <i class="fas fa-sliders mr-1"></i> Inputs
                    </button>
                    <button onclick="updateState('activeTab', 'summary')" class="flex-1 py-3 border-b-2 font-bold text-sm sm:text-base transition-colors ${activeTab === 'summary' ? 'border-[#005088] text-[#005088]' : 'border-transparent text-slate-400 hover:text-slate-600'}">
                        <i class="fas fa-clipboard-list mr-1"></i> Summary
                    </button>
                    <button onclick="updateState('activeTab', 'valuation')" class="flex-1 py-3 border-b-2 font-bold text-sm sm:text-base transition-colors ${activeTab === 'valuation' ? 'border-[#005088] text-[#005088]' : 'border-transparent text-slate-400 hover:text-slate-600'}">
                        <i class="fas fa-calculator mr-1"></i> Valuation
                    </button>
                </div>

                <div class="max-w-4xl mx-auto p-4">
                    
                    <!-- TAB 1: INPUTS (Responsive Grids) -->
                    ${activeTab === 'inputs' ? `
                    <div class="tab-content bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                        <h3 class="font-bold border-b border-slate-100 pb-2 mb-4 text-slate-700 flex items-center gap-2 text-base uppercase tracking-wide">System Configuration</h3>
                        
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                            ${S("Ownership Agreement", o, "o", [{ v: "owned", l: "Homeowner Owned" }, { v: "lease", l: "Lease (Fixed Payment)" }, { v: "ppa", l: "PPA (Pay per kWh)" }], "Select the type of ownership agreement.")}
                            ${I("Property Address", a, "a", "text", "Property address for report generation and solar data lookup.")}
                        </div>

                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4 bg-slate-50 p-3 rounded-lg border border-slate-100">
                             ${I("Panels (Count)", pC, "pC", "number", "Total number of solar panels.", "1")}
                             ${I("Panel Watts", pW, "pW", "number", "Power rating per panel in Watts (e.g., 250, 400).", "1")}
                             ${S("Inverter", it, "it", [{ v: "string", l: "String Inverter" }, { v: "micro", l: "Microinverter" }], "Type of inverter installed.")}
                             ${I("Battery kWh", b, "b", "number", "Total capacity of installed batteries in kWh (0 if none).")}
                        </div>

                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                            ${I("Install Date", iDt, "iDt", "date", "Date the system was turned on (Permission to Operate).")}
                            ${I("Lifetime MWh", ac, "ac", "number", "Cumulative lifetime production from the inverter (in MWh).")}
                            ${I("Reading Date", pDt, "pDt", "date", "Date the lifetime energy reading was taken.")}
                            ${S("Utility Rate", ut, "ut", [{ v: "nem2", l: "NEM 2" }, { v: "nem3", l: "NEM 3" }, { v: "roseville", l: "Roseville" }, { v: "smud", l: "SMUD" }, { v: "xcel_co", l: "Xcel Co" }, { v: "other", l: "Other" }], "The utility rate plan applied to the solar savings.")}
                        </div>

                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 mb-4">
                            ${S("Direction", or, "or", [{ v: "south", l: "South" }, { v: "mix", l: "Mix" }, { v: "east_west", l: "East/West" }, { v: "north", l: "North" }], "General direction the panels are facing.")}
                            ${S("Roof Pitch", pi, "pi", [{ v: "standard", l: "Standard" }, { v: "flat", l: "Flat" }, { v: "steep", l: "Steep" }], "Steepness of the roof where panels are mounted.")}
                            ${S("Shading", sh, "sh", [{ v: "none", l: "None" }, { v: "some", l: "Some" }, { v: "alot", l: "Heavy" }], "Estimated amount of shade the system receives.")}
                        </div>

                        ${o === 'lease' || o === 'ppa' ? `
                        <div class="bg-blue-50 p-4 rounded-lg border border-blue-100 mt-4">
                            <h4 class="font-bold text-blue-800 text-sm uppercase mb-3 border-b border-blue-200 pb-1">Contract Details</h4>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                ${I("Contract Term (Years)", te, "te", "number", "Length of the contract in years.", "1")}
                                ${I("Annual Escalator (%)", tEs, "tEs", "number", "Annual percentage increase in payment.")}
                                ${I("Year 1 Est. Production (kWh)", tE, "tE", "number", "Estimated production for Year 1 found in the contract.", "1", false, "handleProductionChange")}
                                ${I(o === 'lease' ? "Guaranteed Production (kWh)" : "Estimated Production (kWh)", tG, "tG", "number", o === 'lease' ? "Guaranteed minimum production for Year 1." : "Estimated production from PPA contract.", "1")}
                                <div class="col-span-1 sm:col-span-2 grid grid-cols-1 sm:grid-cols-2 gap-4">
                                     ${I("Rate ($/kWh)", (typeof tR === 'number' ? tR.toFixed(3) : tR), "tR", "number", "Price per kWh Year 1.", "0.001", false, "handleRateChange")}
                                     ${I("Monthly Payment ($)", (typeof pa === 'number' ? pa.toFixed(2) : pa), "pa", "number", "Initial monthly payment.", "0.01", false, "handlePaymentChange")}
                                </div>
                                <div class="col-span-1 sm:col-span-2 grid grid-cols-1 sm:grid-cols-2 gap-4 border-t border-blue-200 pt-2 mt-2">
                                     ${I("Total Est. Lifetime (kWh)", r ? num(r.fTe) : 0, "fTe", "text", "Estimated total production over the full contract term.", "", true)}
                                     ${I("Total Guar. Lifetime (kWh)", r ? num(r.fTg) : 0, "fTg", "text", "Guaranteed total production over the full contract term.", "", true)}
                                </div>
                            </div>
                        </div>` : ''}
                    </div>
                    ` : ''}

                    <!-- TAB 2: SUMMARY (Responsive Grids) -->
                    ${activeTab === 'summary' && r ? `
                    <div class="tab-content space-y-4">
                        ${C("System Profile", "A snapshot of the system's physical capacity (kW), current age, and the estimated energy it will produce over the next year.", `
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 pt-2">
                                <div><p class="text-xs uppercase text-slate-500 font-bold">Rated Size</p><p class="text-3xl font-black text-blue-800">${sz.toFixed(2)} kW</p><p class="text-xs text-slate-400">Total DC Power</p></div>
                                <div class="border-l pl-4"><p class="text-xs uppercase text-slate-500 font-bold">Age</p><p class="text-3xl font-black text-blue-800">${r.age.toFixed(1)} <span class="text-sm font-normal text-slate-500">Years</span></p><p class="text-xs text-slate-400">Years since install</p></div>
                                <div class="col-span-1 sm:col-span-2 border-t pt-2 grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <div><p class="text-xs text-slate-500">Est. Next 12 Months</p><p class="text-2xl font-bold text-slate-700">${num(r.estN12 / 1000)} MWh</p><p class="text-xs text-slate-400">Forecasted output</p></div>
                                    <div class="sm:border-l sm:pl-4"><p class="text-xs text-slate-500">Est. Daily Average</p><p class="text-2xl font-bold text-slate-700">${r.estDay.toFixed(1)} kWh</p><p class="text-xs text-slate-400">Average daily yield</p></div>
                                </div>
                            </div>`, 'text-blue-700')}
                        
                        ${o === "owned" ? C("Performance Summary", "Compares the actual lifetime production against the expected output for a system of this specific age, accounting for normal degradation.", `
                            <div class="mb-4 mt-2">
                                <div class="flex justify-between text-xs font-bold mb-3"><span class="${r.pr >= 0.9 ? "text-green-600" : "text-red-600"}">${r.pr >= 0.9 ? "OPTIMIZED" : "UNDERPERFORMING"}</span></div>
                                <div class="relative w-full">
                                    <div class="absolute bottom-full left-[90%] -translate-x-1/2 mb-1 text-[9px] font-bold text-slate-400 whitespace-nowrap">Goal: 90%</div>
                                    <div class="w-full bg-slate-100 h-3 rounded-full overflow-hidden relative">
                                        <div class="absolute h-full w-0.5 bg-slate-400 left-[90%] z-10"></div>
                                        <div class="h-full ${r.pr >= 0.9 ? 'bg-green-500' : 'bg-red-500'}" style="width:${Math.min(r.pr * 100, 100)}%"></div>
                                    </div>
                                </div>
                            </div>
                            ${R("Actual (Lifetime)", num(r.act), "MWh", "Total MWh generated")}
                            ${R("Expected (Lifetime)", num(r.physLifeMwh), "MWh", "Modeled target MWh")}
                            <div class="border-t mt-2 pt-2 flex justify-between items-center"><span class="font-bold">Performance Ratio</span><span class="text-xl font-black ${r.pr >= 0.9 ? 'text-green-600' : 'text-red-600'}">${per(r.pr)}</span></div><p class="text-xs text-slate-400 text-right">Efficiency vs Expected</p>
                        `, r.pr >= 0.9 ? "text-green-600" : "text-red-600") : 
                        C(o === "lease" ? "Production & Guarantee" : "Production Analysis", "Comprehensive analysis of actual output against contract estimates and guarantees.", `
                            <div class="space-y-4">
                                <!-- Estimate Section -->
                                <div>
                                    <h4 class="text-xs font-bold text-slate-400 uppercase mb-2">Performance vs Estimate</h4>
                                    ${R("Contract Estimate", num(r.estLifeMwh), "MWh", "Original sales projection")}
                                    ${R("Actual Production", num(r.act), "MWh", "Metered lifetime output")}
                                    
                                    <div class="mt-2 p-3 bg-slate-50 rounded border border-slate-100">
                                        <div class="flex justify-between items-center mb-1">
                                            <span class="text-xs font-bold text-slate-500 uppercase">Variance</span>
                                            <span class="font-bold ${(r.act - r.estLifeMwh) >= 0 ? 'text-green-600' : 'text-amber-500'}">
                                                ${(r.act - r.estLifeMwh) >= 0 ? '+' : ''}${num(r.act - r.estLifeMwh)} MWh
                                            </span>
                                        </div>
                                        <div class="w-full bg-slate-200 h-2 rounded-full overflow-hidden">
                                            <div class="h-full ${(r.act - r.estLifeMwh) >= 0 ? 'bg-green-500' : 'bg-amber-500'}" style="width: ${Math.min(100, (r.act / r.estLifeMwh) * 100)}%"></div>
                                        </div>
                                        <div class="text-right text-xs font-bold mt-1 ${(r.act - r.estLifeMwh) >= 0 ? 'text-green-600' : 'text-amber-500'}">
                                            ${((r.act / r.estLifeMwh) * 100).toFixed(1)}% of Estimate
                                        </div>
                                    </div>
                                </div>

                                <!-- Guarantee Section (Conditional) -->
                                ${r.guaL > 0 ? `
                                <div class="border-t border-slate-100 pt-4">
                                    <h4 class="text-xs font-bold text-slate-400 uppercase mb-2">Contract Guarantee Status</h4>
                                    ${R(tpoGuarLabel, num(r.guaL), "MWh", "Minimum contractual floor")}
                                    
                                    <div class="flex items-center gap-3 mt-3 p-3 rounded-lg border-2 ${r.gDiff >= 0 ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'}">
                                        <div class="text-2xl">${r.gDiff >= 0 ? '✅' : '⚠️'}</div>
                                        <div class="flex-1">
                                            <div class="text-sm font-black uppercase ${r.gDiff >= 0 ? 'text-green-800' : 'text-red-800'}">
                                                ${r.gDiff >= 0 ? 'PASSING' : 'FAILING'}
                                            </div>
                                            <div class="text-xs text-slate-600">
                                                ${r.gDiff >= 0 ? 
                                                    `Exceeds guarantee by <strong>${num(r.gDiff)} MWh</strong>` : 
                                                    `Underperforming by <strong>${num(Math.abs(r.gDiff))} MWh</strong>. Claim likely available.`}
                                            </div>
                                        </div>
                                    </div>
                                </div>` : ''}

                                <!-- NEW SUMMARY -->
                                ${leaseAssessment}

                            </div>
                        `, 'text-blue-700', '📊')}

                        ${o === "owned" ? C("Est. Utility Savings", "The estimated financial value of the energy produced, calculated against current utility rates.", `
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4 border-b pb-4">
                                <div><p class="text-xs font-bold text-slate-400">Future Savings</p><p class="text-lg font-black">${cur(r.futSav)}</p><p class="text-xs text-slate-400">Value of energy offset</p></div>
                                <div><p class="text-xs font-bold text-slate-400">Total Lifetime</p><p class="text-lg font-black">${cur(r.totSav)}</p><p class="text-xs text-slate-400">25-year cumulative savings</p></div>
                            </div>
                            <div class="space-y-2 border-b pb-4 mb-2">
                                <div class="flex justify-between"><span class="font-bold text-sm text-slate-600">Current Year Annual</span><span class="font-bold text-green-700">${cur(r.actSav)}</span></div>
                                <p class="text-xs text-slate-400 text-right -mt-1 mb-2">This year's benefit</p>
                                <div class="flex justify-between"><span class="font-bold text-sm text-slate-600">Current Monthly Average</span><span class="font-bold text-slate-700">${cur(r.actSav / 12)}</span></div>
                                <p class="text-xs text-slate-400 text-right -mt-1">Avg monthly bill offset</p>
                            </div>
                            <div class="pt-2">
                                ${r.loss > 0 ? `
                                    <div class="flex justify-between items-baseline"><span class="text-xs font-bold text-slate-400 uppercase">Potential Annual Savings (If Refurbished)</span><span class="font-bold text-green-600">${cur(r.potSav)}</span></div>
                                    <div class="mt-2 bg-red-50 text-red-800 p-2 rounded text-xs text-center border border-red-100">
                                        <strong>Estimated Annual Loss: -${cur(r.loss)}</strong><br/>
                                        <span class="opacity-80 font-medium">Financial value lost due to current efficiency issues.</span>
                                    </div>
                                ` : `
                                    <div class="mt-2 bg-green-50 text-green-800 p-2 rounded text-xs text-center border border-green-100">
                                        <strong><i class="fas fa-check-circle mr-1"></i> System Performing Optimally</strong><br/>
                                        <span class="opacity-80 font-medium">Actual output exceeds modeled expectations. No refurbishment required.</span>
                                    </div>
                                `}
                            </div>
                        `, 'text-green-700', '💰') : C("Est. Utility Savings", "Calculates the financial value of the solar energy produced, comparing current monthly averages to total lifetime savings.", `
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4 border-b pb-4">
                                <div><p class="text-xs font-bold text-slate-400">Future Savings</p><p class="text-lg font-black">${cur(r.futSav)}</p><p class="text-xs text-slate-400">Value of energy offset</p></div>
                                <div><p class="text-xs font-bold text-slate-400">Total Lifetime</p><p class="text-lg font-black">${cur(r.totSav)}</p><p class="text-xs text-slate-400">${te}-year contract savings</p></div>
                            </div>
                            <div class="space-y-2 border-b pb-4 mb-2">
                                <div class="flex justify-between"><span class="font-bold text-sm text-slate-600">Current Year Annual</span><span class="font-bold text-green-700">${cur(r.actSav)}</span></div>
                                <p class="text-xs text-slate-400 text-right -mt-1 mb-2">This year's benefit</p>
                                <div class="flex justify-between"><span class="font-bold text-sm text-slate-600">Current Monthly Avg</span><span class="font-bold text-slate-700">${cur(r.actSav / 12)}</span></div>
                                <p class="text-xs text-slate-400 text-right -mt-1">Avg monthly bill offset</p>
                            </div>
                            <div class="pt-2">
                                ${r.loss > 0 ? `
                                    <div class="flex justify-between items-baseline"><span class="text-xs font-bold text-slate-400 uppercase">Potential Annual Value</span><span class="font-bold text-green-600">${cur(r.potSav)}</span></div>
                                    <div class="mt-2 bg-red-50 text-red-800 p-2 rounded text-xs text-center border border-red-100">
                                        <strong>Unrealized Value: -${cur(r.loss)}</strong><br/>
                                        <span class="opacity-80 font-medium">Value lost due to underperformance. May support a performance claim.</span>
                                    </div>
                                ` : `
                                    <div class="mt-2 bg-green-50 text-green-800 p-2 rounded text-xs text-center border border-green-100">
                                        <strong><i class="fas fa-check-circle mr-1"></i> System Performing Optimally</strong><br/>
                                        <span class="opacity-80 font-medium">Actual output exceeds modeled expectations.</span>
                                    </div>
                                `}
                            </div>
                        `, 'text-green-700', '💰')}

                        ${o === "owned" ? C("Warranty & Health", "Estimates the remaining life of critical hardware like inverters and batteries. 'Risk' indicates the component is nearing the end of its typical lifespan.", `
                            <div class="space-y-4">
                                <div>
                                    <div class="flex justify-between text-sm mb-1 font-bold"><span class="text-slate-600">${invLabel}</span><span class="${invTextColor}">${invStatus}</span></div>
                                    <div class="w-full bg-slate-100 h-2 rounded-full"><div class="h-2 rounded-full ${invColor}" style="width:${Math.min(r.age / invLife * 100, 100)}%"></div></div>
                                    <p class="text-xs text-slate-400 mt-1">${invMsg} <span class="font-semibold text-slate-500">Est. Life: ${it === 'micro' ? '25 Years' : '10-12 Years'}</span></p>
                                </div>
                                <div>
                                    <div class="flex justify-between text-sm mb-1 font-bold"><span class="text-slate-600">Solar Panel</span><span class="${panelTextColor}">${panelStatus}</span></div>
                                    <div class="w-full bg-slate-100 h-2 rounded-full relative"><div class="absolute h-full w-0.5 bg-slate-300 left-[80%]"></div><div class="${panelColor} h-2 rounded-full" style="width:${((100 - (r.age * 0.5)) * r.pr)}%"></div></div>
                                    <p class="text-xs text-slate-400 mt-1">${panelMsg} <span class="font-semibold text-slate-500">Est. Life: 25-30 Years</span></p>
                                </div>
                                ${b > 0 ? `<div>
                                    <div class="flex justify-between text-sm mb-1 font-bold"><span class="text-slate-600">Battery (10 Years)</span><span class="${r.age < 10 ? 'text-green-600' : 'text-red-500'}">${r.age < 10 ? 'Good' : 'Replace'}</span></div>
                                    <div class="w-full bg-slate-100 h-2 rounded-full"><div class="h-2 rounded-full ${r.age < 10 ? 'bg-green-500' : 'bg-red-500'}" style="width:${Math.min(r.age / 10 * 100, 100)}%"></div></div>
                                    <p class="text-xs text-slate-400 mt-1">Energy storage health</p>
                                </div>` : ''}
                            </div>
                        `, `text-slate-700`, '🛡️') : C("TPO Lifetime Costs", "The sum of all remaining monthly payments for the duration of the contract, accounting for the annual price increase (escalator).", `
                            <div class="flex justify-between items-end border-b pb-2 mb-2"><div><p class="text-xs font-bold text-slate-400">Total Cost</p><p class="text-2xl font-black">${cur(r.tCost)}</p><p class="text-xs text-slate-400">Sum of all payments (${te} Year Term)</p></div><div class="text-right"><p class="text-xs font-bold text-slate-400">Escalator</p><p class="text-xl font-bold text-red-600">${tEs}%</p><p class="text-xs text-slate-400">Annual price hike</p></div></div>
                            <div class="bg-slate-50 rounded text-sm">
                                <div class="grid grid-cols-3 p-2 font-bold text-slate-500 border-b"><span>Period</span><span class="text-center">Monthly Payment</span><span class="text-right">Rate ($/kWh)</span></div>
                                <div class="grid grid-cols-3 p-2 border-b"><span>Year 1</span><span class="text-center">${cur(r.pY1)}</span><span class="text-right text-slate-400">$${r.rY1.toFixed(3)}</span></div>
                                <div class="grid grid-cols-3 p-2 bg-blue-50 text-blue-800 font-bold border-b"><span>Current</span><span class="text-center">${cur(r.pYC)}</span><span class="text-right">$${r.rYC.toFixed(3)}</span></div>
                                <div class="grid grid-cols-3 p-2 text-slate-500"><span>End (${new Date(iDt).getFullYear() + te})</span><span class="text-center">${cur(r.pYL)}</span><span class="text-right">$${r.rYL.toFixed(3)}</span></div>
                            </div>
                        `, `text-slate-700`, '📄')}
                    </div>
                    ` : ''}

                    <!-- TAB 3: VALUATION (Responsive Grids) -->
                    ${activeTab === 'valuation' && aR ? `
                    <div class="tab-content space-y-4">
                        <div class="bg-slate-800 text-white p-5 rounded-xl shadow relative overflow-hidden">
                             <div class="relative z-10 text-center">
                                 <p class="text-xs font-bold text-blue-300 uppercase tracking-widest mb-1">Fair Market Value</p>
                                 <p class="text-4xl font-extrabold mb-1">${cur(aR.val + aR.tr)}</p>
                                 <p class="text-xs text-slate-400">${mt} Method ${mt === "Blended" ? `(${w}% Income)` : ''}</p>
                             </div>
                        </div>

                        <div class="bg-slate-700 p-4 rounded-xl border border-slate-600">
                             <h4 class="text-xs font-bold text-white uppercase mb-3 border-b border-slate-600 pb-2">Adjustments</h4>
                             <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                 ${Idark("Discount Rate (%)", dr, "dr", "number", "Risk-adjusted discount rate for future cash flows.")}
                                 ${Idark("Utility Escalation (%)", e, "e", "number", "Estimated annual increase in utility electricity rates.")}
                                 ${Idark("Est. Repairs ($)", rp, "rp", "number", "Estimated cost to repair or replace broken components.", "100")}
                                 ${Idark("Replacement Cost ($/W)", rC, "rC", "number", "Current market cost to install a new system ($/Watt).", "0.1")}
                                 ${Idark("Useful Life (Years)", l, "l", "number", "Total operational life. Industry Std: 25-30y. (Note: TPOs often claim 35y to inflate value).")}
                                 ${Sdark("Export / NEM Policy", ne, "ne", [{v:1.0, l:"Full Retail Credit (NEM 1.0/2.0)"}, {v:0.8, l:"High Export Rate ($0.15+)"}, {v:0.5, l:"Reduced Rate (NEM 3.0)"}, {v:0.2, l:"Wholesale Rate (<$0.05)"}, {v:0.0, l:"No Export Credit"}], "How the utility credits surplus energy.")}
                                 ${Idark("Condition (0-1)", c, "c", "number", window.state.aC ? "Auto-calculated based on production." : "Manual condition factor (0.0 - 1.0).", "0.1", window.state.aC)}
                                 <div class="col-span-1 sm:col-span-2 pt-2">
                                     <label class="block text-blue-200 text-xs mb-1 font-bold uppercase">Valuation Method</label>
                                     <div class="flex gap-1">
                                         ${['Cost', 'Blended', 'Income'].map(M => `<button onclick="updateState('mt','${M}')" class="flex-1 py-1 text-xs font-bold rounded ${mt === M ? 'bg-blue-500 text-white' : 'bg-slate-600 text-slate-300'}">${M}</button>`).join('')}
                                     </div>
                                 </div>
                             </div>
                        </div>

                         <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                             ${C("Cost Basis", "", `<p class="text-xl font-bold text-slate-700">${cur(aR.cost)}</p><p class="text-xs text-slate-400">Depreciated Replacement</p>`, 'text-slate-700')}
                             ${C("Income Basis", "", `<p class="text-xl font-bold text-green-700">${cur(aR.inc)}</p><p class="text-xs text-slate-400">Discounted Cash Flow</p>`, 'text-green-700')}
                          </div>
                    </div>
                    ` : ''}

                </div>

                <!-- REPORT MODAL -->
                <dialog id="print-modal" class="modal p-0 rounded-lg shadow-2xl backdrop:bg-slate-900/50">
                    <div class="bg-white p-6 w-80 rounded-xl relative">
                        <button onclick="closeModal()" class="absolute top-3 right-3 text-slate-400 hover:text-slate-600"><i class="fas fa-times"></i></button>
                        <h3 class="font-bold mb-4 text-slate-800">Select Report</h3>
                        
                        <!-- NEW REPORT MODE TOGGLE -->
                        <div class="flex bg-slate-100 p-1 rounded-lg mb-4">
                            <button onclick="updateState('reportMode', 'standard')" class="flex-1 py-1 text-xs font-bold rounded-md transition-all duration-200 ${reportMode === 'standard' ? 'bg-white shadow text-indigo-600' : 'text-slate-500 hover:text-slate-700'}">Standard</button>
                            <button onclick="updateState('reportMode', 'ai')" class="flex-1 py-1 text-xs font-bold rounded-md transition-all duration-200 ${reportMode === 'ai' ? 'bg-white shadow text-purple-600' : 'text-slate-500 hover:text-slate-700'}">AI Consultant</button>
                        </div>

                        <div class="space-y-2">
                            <button onclick="handleGenerateReport('owned')" class="w-full text-left p-3 border rounded hover:bg-slate-50 text-sm font-bold text-slate-700"><i class="fas fa-house-chimney text-blue-500 mr-2"></i> Owned System</button>
                            ${o === 'lease' ? `<button onclick="handleGenerateReport('lease')" class="w-full text-left p-3 border rounded hover:bg-slate-50 text-sm font-bold text-slate-700"><i class="fas fa-file-signature text-purple-500 mr-2"></i> Lease Assumption</button>` : ''}
                            ${o === 'ppa' ? `<button onclick="handleGenerateReport('ppa')" class="w-full text-left p-3 border rounded hover:bg-slate-50 text-sm font-bold text-slate-700"><i class="fas fa-bolt text-yellow-500 mr-2"></i> PPA Transfer</button>` : ''}
                            <button onclick="handleGenerateReport('val')" class="w-full text-left p-3 border rounded hover:bg-slate-50 text-sm font-bold text-slate-700"><i class="fas fa-scale-balanced text-emerald-500 mr-2"></i> Valuation / FMV</button>
                        </div>
                    </div>
                </dialog>

            </div>
            `;
            root.innerHTML = html;

            // --- CRITICAL FIX: Restore Open Modal ---
            if (activeModal) {
                const modal = document.getElementById(activeModal);
                if (modal && !modal.open) {
                    modal.showModal();
                }
            }
        };

        // --- ASSIGN TO WINDOW AFTER DECLARATION ---
        window.calculate = calculate;
        window.render = render;
        window.handleGenerateReport = handleGenerateReport;
        window.openModal = openModal;
        window.closeModal = closeModal;

        window.updateState = function(key, value) { window.state[key] = value; calculate(); render(); };
        window.handleInputChange = function(event, key) {
            let value = event.target.value;
            if (event.target.type === 'number') { value = value === "" ? "" : parseFloat(value); }
            if (event.target.type === 'range') { value = parseInt(value); }
            window.state[key] = value; calculate(); render();
        };
        
        // --- AUTO-CALCULATION HANDLERS ---
        window.handleProductionChange = function(event, key) {
            const tE = parseFloat(event.target.value); window.state[key] = tE;
            if (!isNaN(tE) && window.state.tR) { window.state.pa = (window.state.tR * tE) / 12; }
            calculate(); render();
        };
        window.handleRateChange = function(event, key) {
            const tR = parseFloat(event.target.value); window.state[key] = tR;
            if (!isNaN(tR) && window.state.tE) { window.state.pa = (tR * window.state.tE) / 12; }
            calculate(); render();
        };
        window.handlePaymentChange = function(event, key) {
            const pa = parseFloat(event.target.value); window.state[key] = pa;
            if (!isNaN(pa) && window.state.tE && window.state.tE > 0) { window.state.tR = (pa * 12) / window.state.tE; }
            calculate(); render();
        };

        // Initialize on Load
        document.addEventListener('DOMContentLoaded', () => {
            calculate();
            render();
        });
    </script>
</body>
</html>